<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAC Test</title>
</head>
<body>
    <div id="bac">0.0</div>
    <div id="time">0</div>
    <script type="text/javascript">
        timescale = 60;
        function coroutine(f, ins,outs) {
            var o = f(ins,outs); // instantiate the coroutine
            o.next(); // execute until the first yield
            return function(x) {
                o.next(x);
            }
        }
        let ins =  {
            blabel: document.getElementById("bac"), 
            tlabel: document.getElementById("time"), 
            drinks: 0, 
            factor:1
        }

        let outs = {
            timesteps: [],
            drinksDue: 0,
            time: 0,
        }
        var update = coroutine(function*(ins, outs){
            console.log(ins)
            const d = new Date()
            const startTime = d.getTime()
            var oldTime = d.getTime()
            var bac = 0
            var sa = 0
            var male = true
            const weight = 80
            const v_d = weight * (male ? 0.71 : 0.58)
            console.log(v_d)
            var d_g = true

            let P=1,I=0,D=0.1
            let af = 1
            let Vf =1

            while(true){
                yield
                const d = new Date()
                var dt = d.getTime()-oldTime
                var totalTime = (d.getTime()-startTime)/3600000*timescale
                var oldTime = d.getTime()
                var dt = dt/3600000*timescale

                if(ins.drinks > 0){
                    console.log("Drank at: " + totalTime)
                    sa += 1.4/v_d*ins.factor*Vf*ins.drinks
                    ins.drinks = 0
                }
                var transfer = 7*sa*af
                var decay = 1/(1+1/(500*bac+0.0001))*0.015
                
                bac += (transfer-decay)*dt
                sa -= transfer*dt

                outs.timesteps.push({Time:totalTime, BAC:bac})

                ins.tlabel.innerHTML = totalTime
                ins.blabel.innerHTML = bac
            }
        }, ins, outs)
        setInterval(update, 1000)
        ins.drinks = 2
        setTimeout(()=>ins.drinks+= 0, 10000)
        
    </script>
</body>
</html>